#!/bin/bash

echo "=== –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –¢–†–ê–§–ò–ö–ê –í STRANGLER FIG –ü–†–û–ö–°–ò ==="
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
reset_stats() {
    echo "üîÑ –°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞..."
    curl -s -X POST http://localhost:8000/api/traffic-stats/reset
    echo
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
get_stats() {
    echo "üìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞:"
    curl -s http://localhost:8000/api/traffic-stats | jq '.' 2>/dev/null || curl -s http://localhost:8000/api/traffic-stats
    echo
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
make_requests() {
    local count=$1
    echo "üöÄ –í—ã–ø–æ–ª–Ω—è–µ–º $count –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API —Ñ–∏–ª—å–º–æ–≤..."
    for i in $(seq 1 $count); do
        curl -s http://localhost:8000/api/movies > /dev/null
        if [ $((i % 10)) -eq 0 ]; then
            echo "   –í—ã–ø–æ–ª–Ω–µ–Ω–æ $i –∑–∞–ø—Ä–æ—Å–æ–≤..."
        fi
    done
    echo "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ $count –∑–∞–ø—Ä–æ—Å–æ–≤"
    echo
}

echo "1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 0% –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –º–æ–Ω–æ–ª–∏—Ç):"
echo "   MOVIES_MIGRATION_PERCENT=0"
reset_stats
make_requests 20
get_stats
echo

echo "2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 50% –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ):"
echo "   MOVIES_MIGRATION_PERCENT=50"
reset_stats
make_requests 20
get_stats
echo

echo "3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 100% –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å):"
echo "   MOVIES_MIGRATION_PERCENT=100"
reset_stats
make_requests 20
get_stats
echo

echo "4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 25% –º–∏–≥—Ä–∞—Ü–∏–∏ (25% –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, 75% –Ω–∞ –º–æ–Ω–æ–ª–∏—Ç):"
echo "   MOVIES_MIGRATION_PERCENT=25"
reset_stats
make_requests 20
get_stats
echo

echo "5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 75% –º–∏–≥—Ä–∞—Ü–∏–∏ (75% –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, 25% –Ω–∞ –º–æ–Ω–æ–ª–∏—Ç):"
echo "   MOVIES_MIGRATION_PERCENT=75"
reset_stats
make_requests 20
get_stats
echo

echo "=== –û–ë–™–Ø–°–ù–ï–ù–ò–ï –†–ê–ë–û–¢–´ ==="
echo "üîç –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞:"
echo "   - –ü—Ä–∏ 0%: 100% –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–¥—É—Ç –Ω–∞ –º–æ–Ω–æ–ª–∏—Ç"
echo "   - –ü—Ä–∏ 50%: —Å–ª—É—á–∞–π–Ω–æ 50% –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, 50% –Ω–∞ –º–æ–Ω–æ–ª–∏—Ç"
echo "   - –ü—Ä–∏ 100%: 100% –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–¥—É—Ç –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å"
echo "   - –ü—Ä–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö: —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"
echo
echo "üìà –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:"
echo "   - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
echo "   - üèõÔ∏è  = –∑–∞–ø—Ä–æ—Å –∫ –º–æ–Ω–æ–ª–∏—Ç—É"
echo "   - üöÄ = –∑–∞–ø—Ä–æ—Å –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—É"
echo
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:"
echo "   - GET /api/traffic-stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞"
echo "   - POST /api/traffic-stats/reset - —Å–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
echo
echo "üéØ –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–∏—Ç–µ MOVIES_MIGRATION_PERCENT –≤ docker-compose.yml"
